import logging
from aiogram import Router, Dispatcher, types, Bot
from aiogram.filters import Command
from bot.middlewares.auth_middleware import AuthorizationMiddleware
from bot.middlewares.error_middleware import ErrorHandlerMiddleware

logger = logging.getLogger(__name__)
router = Router()

@router.message(Command(commands=['start', 's', 'help', 'h']))
async def handle_start(message: types.Message, bot: Bot):
    try:
        username = message.from_user.username
        content = message.text.split()
        if len(content) == 1:
            basic_message = """```ğŸWitaj_w_RanczoKlipy!ğŸ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ” Podstawowe komendy ğŸ”
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ” /klip <cytat> - Wyszukuje klip na podstawie cytatu. PrzykÅ‚ad: /klip geniusz.
ğŸ”” /subskrypcja - Sprawdza stan Twojej subskrypcji.

Aby uzyskaÄ‡ peÅ‚nÄ… listÄ™ komend, uÅ¼yj /start lista.
```"""
            await message.answer(basic_message, parse_mode='Markdown')
            logger.info(f"Basic start message sent to user '{username}'.")

        elif len(content) == 2 and content[1] == 'lista':
            lista_message = """```ğŸRanczoKlipy-DziaÅ‚y_KomendğŸ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ” Wyszukiwanie i przeglÄ…danie klipÃ³w 
ğŸ‘‰ /start wyszukiwanie
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âœ‚ï¸ Edycja klipÃ³w                      
ğŸ‘‰ /start edycja
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“ ZarzÄ…dzanie zapisanymi klipami     
ğŸ‘‰ /start zarzÄ…dzanie
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ› ï¸ Raportowanie bÅ‚Ä™dÃ³w              
ğŸ‘‰ /start raportowanie  
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ”” Subskrypcje                       
ğŸ‘‰ /start subskrypcje
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“œ Wszystkie komendy                 
ğŸ‘‰ /start all
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```"""
            await message.answer(lista_message, parse_mode='Markdown')
            logger.info(f"List of sections sent to user '{username}'.")

        elif len(content) == 2 and content[1] == 'all':
            full_message = """```ğŸWitaj_w_RanczoKlipy!ğŸ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ” Wyszukiwanie i przeglÄ…danie klipÃ³w ğŸ”
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ” /klip <cytat> - Wyszukuje klip na podstawie cytatu. PrzykÅ‚ad: /klip geniusz.
ğŸ” /szukaj <cytat> - Znajduje klipy pasujÄ…ce do cytatu (pierwsze 5 wynikÃ³w). PrzykÅ‚ad: /szukaj kozioÅ‚.
ğŸ“‹ /lista - WyÅ›wietla wszystkie klipy znalezione przez /szukaj.
âœ… /wybierz <numer_klipu> - Wybiera klip z listy uzyskanej przez /szukaj do dalszych operacji. PrzykÅ‚ad: /wybierz 1.
ğŸ“º /odcinki <sezon> - WyÅ›wietla listÄ™ odcinkÃ³w dla podanego sezonu. PrzykÅ‚ad: /odcinki 2.
âœ‚ï¸ /wytnij <sezon_odcinek> <czas_start> <czas_koniec> - Wytnij fragment klipu. PrzykÅ‚ad: /wytnij S02E10 20:30.11 21:32.50.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âœ‚ï¸ Edycja klipÃ³w âœ‚ï¸
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“ /dostosuj <przedÅ‚uÅ¼enie_przed> <przedÅ‚uÅ¼enie_po> - Dostosowuje wybrany klip. PrzykÅ‚ad: /dostosuj 5 5.
ğŸ“ /dostosuj <numer_klipu> <przedÅ‚uÅ¼enie_przed> <przedÅ‚uÅ¼enie_po> - Dostosowuje klip z wybranego zakresu. PrzykÅ‚ad: /dostosuj 1 5 5.
ğŸï¸ /kompiluj wszystko - Tworzy kompilacjÄ™ ze wszystkich klipÃ³w.
ğŸï¸ /kompiluj <zakres> - Tworzy kompilacjÄ™ z zakresu klipÃ³w. PrzykÅ‚ad: /kompiluj 1-4.
ğŸï¸ /kompiluj <numer_klipu1> <numer_klipu2> ... - Tworzy kompilacjÄ™ z wybranych klipÃ³w. PrzykÅ‚ad: /kompiluj 1 5 7.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“ ZarzÄ…dzanie zapisanymi klipami ğŸ“
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ’¾ /zapisz <nazwa> - Zapisuje wybrany klip z podanÄ… nazwÄ…. PrzykÅ‚ad: /zapisz moj_klip.
ğŸ“‚ /mojeklipy - WyÅ›wietla listÄ™ zapisanych klipÃ³w.
ğŸ“¤ /wyslij <nazwa> - WysyÅ‚a zapisany klip o podanej nazwie. PrzykÅ‚ad: /wyslij moj_klip.
ğŸ”— /polaczklipy <numer_klipu1> <numer_klipu2> ... - ÅÄ…czy zapisane klipy w jeden. Numery klipÃ³w moÅ¼na znaleÅºÄ‡ uÅ¼ywajÄ…c komendy /mojeklipy. PrzykÅ‚ad: /polaczklipy 1 2 3.
ğŸ—‘ï¸ /usunklip <nazwa_klipu> - Usuwa zapisany klip o podanej nazwie. PrzykÅ‚ad: /usunklip moj_klip.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ› ï¸ Raportowanie bÅ‚Ä™dÃ³w ï¸
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ› /report - Raportuje bÅ‚Ä…d do administratora.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ”” Subskrypcje ğŸ””
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“Š /subskrypcja - Sprawdza stan Twojej subskrypcji.
```"""
            await message.answer(full_message, parse_mode='Markdown')
            logger.info(f"Full start message sent to user '{username}'.")

        elif len(content) == 2 and content[1] == 'wyszukiwanie':
            wyszukiwanie_message = """```ğŸRanczoKlipy-Wyszukiwanie_i_przeglÄ…danie_klipÃ³wğŸ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ” /klip <cytat> - Wyszukuje klip na podstawie cytatu. PrzykÅ‚ad: /klip geniusz.
ğŸ” /szukaj <cytat> - Znajduje klipy pasujÄ…ce do cytatu (pierwsze 5 wynikÃ³w). PrzykÅ‚ad: /szukaj kozioÅ‚.
ğŸ“‹ /lista - WyÅ›wietla wszystkie klipy znalezione przez /szukaj.
âœ… /wybierz <numer_klipu> - Wybiera klip z listy uzyskanej przez /szukaj do dalszych operacji. PrzykÅ‚ad: /wybierz 1.
ğŸ“º /odcinki <sezon> - WyÅ›wietla listÄ™ odcinkÃ³w dla podanego sezonu. PrzykÅ‚ad: /odcinki 2.
âœ‚ï¸ /wytnij <sezon_odcinek> <czas_start> <czas_koniec> - Wytnij fragment klipu. PrzykÅ‚ad: /wytnij S02E10 20:30.11 21:32.50.
```"""
            await message.answer(wyszukiwanie_message, parse_mode='Markdown')
            logger.info(f"Wyszukiwanie klipÃ³w message sent to user '{username}'.")

        elif len(content) == 2 and content[1] == 'edycja':
            edycja_message = """```ğŸRanczoKlipy-Edycja_klipÃ³wğŸ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âœ‚ï¸ Edycja klipÃ³w âœ‚ï¸
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“ /dostosuj <przedÅ‚uÅ¼enie_przed> <przedÅ‚uÅ¼enie_po> - Dostosowuje wybrany klip. PrzykÅ‚ad: /dostosuj 5 5.
ğŸ“ /dostosuj <numer_klipu> <przedÅ‚uÅ¼enie_przed> <przedÅ‚uÅ¼enie_po> - Dostosowuje klip z wybranego zakresu. PrzykÅ‚ad: /dostosuj 1 5 5.
ğŸï¸ /kompiluj wszystko - Tworzy kompilacjÄ™ ze wszystkich klipÃ³w.
ğŸï¸ /kompiluj <zakres> - Tworzy kompilacjÄ™ z zakresu klipÃ³w. PrzykÅ‚ad: /kompiluj 1-4.
ğŸï¸ /kompiluj <numer_klipu1> <numer_klipu2> ... - Tworzy kompilacjÄ™ z wybranych klipÃ³w. PrzykÅ‚ad: /kompiluj 1 5 7.
```"""
            await message.answer(edycja_message, parse_mode='Markdown')
            logger.info(f"Edycja klipÃ³w message sent to user '{username}'.")

        elif len(content) == 2 and content[1] == 'zarzÄ…dzanie':
            zarzadzanie_message = """```ğŸRanczoKlipy-ZarzÄ…dzanie_zapisanymi_klipamiğŸ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“ ZarzÄ…dzanie zapisanymi klipami ğŸ“
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ’¾ /zapisz <nazwa> - Zapisuje wybrany klip z podanÄ… nazwÄ…. PrzykÅ‚ad: /zapisz moj_klip.
ğŸ“‚ /mojeklipy - WyÅ›wietla listÄ™ zapisanych klipÃ³w.
ğŸ“¤ /wyslij <nazwa> - WysyÅ‚a zapisany klip o podanej nazwie. PrzykÅ‚ad: /wyslij moj_klip.
ğŸ”— /polaczklipy <numer_klipu1> <numer_klipu2> ... - ÅÄ…czy zapisane klipy w jeden. Numery klipÃ³w moÅ¼na znaleÅºÄ‡ uÅ¼ywajÄ…c komendy /mojeklipy. PrzykÅ‚ad: /polaczklipy 1 2 3.
ğŸ—‘ï¸ /usunklip <nazwa_klipu> - Usuwa zapisany klip o podanej nazwie. PrzykÅ‚ad: /usunklip moj_klip.
```"""
            await message.answer(zarzadzanie_message, parse_mode='Markdown')
            logger.info(f"ZarzÄ…dzanie zapisanymi klipami message sent to user '{username}'.")

        elif len(content) == 2 and content[1] == 'raportowanie':
            raportowanie_message = """```ğŸRanczoKlipy-Raportowanie_bÅ‚Ä™dÃ³wğŸ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ› ï¸ Raportowanie bÅ‚Ä™dÃ³w ï¸
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ› /report - Raportuje bÅ‚Ä…d do administratora.
```"""
            await message.answer(raportowanie_message, parse_mode='Markdown')
            logger.info(f"Raportowanie bÅ‚Ä™dÃ³w message sent to user '{username}'.")

        elif len(content) == 2 and content[1] == 'subskrypcje':
            subskrypcje_message = """```ğŸRanczoKlipy-SubskrypcjeğŸ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ”” Subskrypcje ğŸ””
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“Š /subskrypcja - Sprawdza stan Twojej subskrypcji.
```"""
            await message.answer(subskrypcje_message, parse_mode='Markdown')
            logger.info(f"Subskrypcje message sent to user '{username}'.")

    except Exception as e:
        logger.error(f"Error in handle_start for user '{message.from_user.username}': {e}", exc_info=True)
        await message.answer("âš ï¸ WystÄ…piÅ‚ bÅ‚Ä…d podczas przetwarzania Å¼Ä…dania. Prosimy sprÃ³bowaÄ‡ ponownie pÃ³Åºniej.")

def register_start_command(dispatcher: Dispatcher):
    dispatcher.include_router(router)

# Ustawienie middleware'Ã³w
router.message.middleware(AuthorizationMiddleware())
router.message.middleware(ErrorHandlerMiddleware())
